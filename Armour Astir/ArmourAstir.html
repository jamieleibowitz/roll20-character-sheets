<input class="focus-shadow" type="hidden" name="attr_setting_focus_shadow" value="1"/>
<input class="show-broadcast" type="hidden" name="attr_setting_show_broadcast" value="1"/>
<input class="show-itemdesc" type="hidden" name="attr_setting_show_itemdesc" value="1"/>
<input class="use-kirsty" type="hidden" name="attr_setting_usekirsty" value="0"/>
<input class="flexwidth" type="hidden" name="attr_setting_flexwidth" value="0"/>
<input type="hidden" name="attr_changed_attributes" value=""/>
<input type="hidden" name="attr_bonusdice" value="Bonus dice"/>
<input type="hidden" name="attr_numberofdice" value=" {{?{Number of dice|0,zerodice=[[d6]]&amp;#44; [[d6]]|1,dice=[[d6]]|2,dice=[[d6]]&amp;#44; [[d6]]|3,dice=[[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]|4,dice=[[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]|5,dice=[[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]|6,dice=[[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]&amp;#44; [[d6]]}}}"/>
<input type="hidden" name="attr_notes_query" value="?{Notes}"/>
<input type="hidden" name="attr_position_query" value="?{Position|Risky,position=Risky|Controlled,position=Controlled|Desperate,position=Desperate|Fortune roll,position=}"/>
<input type="hidden" name="attr_effect_query" value="?{Effect|Standard|Limited|Great|Extreme|Zero}"/>
<input type="hidden" name="attr_consequence_query" value="^{a_consequence}"/>
<input type="hidden" name="attr_stress_max" value="9"/>
<input type="hidden" name="attr_trauma_max" value="4"/>
<input type="hidden" name="attr_coin_max" value="4"/>
<input type="hidden" name="attr_stash_max" value="40"/>
<input type="hidden" name="attr_playbook_xp_max" value="8"/>
<input type="hidden" name="attr_rep_max" value="12"/>
<input type="hidden" name="attr_turf_max" value="6"/>
<input type="hidden" name="attr_crew_tier_max" value="4"/>
<input type="hidden" name="attr_heat_max" value="9"/>
<input type="hidden" name="attr_wanted_max" value="4"/>
<input type="hidden" name="attr_crewcoin_max" value="16"/>
<input type="hidden" name="attr_crew_xp_max" value="8"/>
<div class="container">
  <!-- Character Sheet-->
  <div class="col100 flex-wrap playbook header generaterow">
    <div class="game-select-box">
      <div class="game-select-option-box">
        <input type="radio" class="game-select" name="game-type-select" value="advent" checked="checked"/><span data-i18n="advent"></span>
      </div>
      <div class="game-select-option-box">
        <input type="radio" class="game-select" name="game-type-select" value="ascent"/><span data-i18n="ascent"></span>
      </div>
    </div>
    <div class="game-title">
      <h1 class="game-title" data-i18n="game-title"></h1>
      <h2 class="advent-kana" style="display: none">アドベント</h2>
      <h2 class="ascent-kana">アセント</h2>
    </div>
    <div class="playbook-selector-box">
      <h3 class="playbook-label" data-i18n="playbook-label"></h3>
      <select name="playbook-dropdown" title="Select playbook">
        <option value="" data-i18n="playbook-default" selected></option>
        <option value="channelers" data-i18n="channelers" disabled></option>
        <option value="arcanist" data-i18n="arcanist"></option>
        <option value="impostor" data-i18n="impostor"></option>
        <option value="paradigm" data-i18n="paradigm"></option>
        <option value="witch" data-i18n="witch"></option>
        <option value="support" data-i18n="support" disabled></option>
        <option value="scout" data-i18n="scout"></option>
        <option value="captain" data-i18n="captain"></option>
        <option value="artificer" data-i18n="artificer"></option> 
        <option value="diplomat" data-i18n="diplomat"></option>
        <option value="other" data-i18n="other-playbooks" disabled></option>
        <option value="custom" data-i18n="custom-playbook"></option>
      </select>
    </div>
  </div>
  <div class="type-character flex">
    
    <!-- Left column-->
    <div class="col55 flex-wrap">
      <!-- Header text fields-->
      <div class="col100 header flex">
        <label class="col55">
          <input type="text" spellcheck="false" name="attr_name"/>
          <div class="label text title" data-i18n="name"></div>
        </label>
        <label class="col45">
          <input type="text" spellcheck="false" name="attr_alias"/>
          <div class="label text title" data-i18n="alias"></div>
        </label>
        <label class="col100">
          <input type="text" spellcheck="false" name="attr_look"/>
          <div class="label text title" data-i18n="look"></div>
        </label>
      </div>
      <!-- Advancement-->
      <div class="col100 def-margin">
        <div class="advancement-header flex blackheader">
          <div class="label markxp" data-i18n="mark_xp:"></div>
          <div class="label" data-i18n="playbook_advancement"></div>
          <div class="xpholder flex">
            <input class="tooth zero" type="radio" name="attr_playbook_xp" value="0" checked="checked"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="1"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="2"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="3"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="4"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="5"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="6"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="7"/><span></span>
            <input class="tooth xptooth" type="radio" name="attr_playbook_xp" value="8"/><span></span>
          </div>
        </div>
        <ul class="advancement-desc">
          <li data-i18n="xp_desperate"></li>
          <li class="nondot" data-i18n="xp_top"></li>
          <li>
            <div class="auto-expand"><span name="attr_xp_condition"></span>
              <textarea spellcheck="false" name="attr_xp_condition" data-i18n-placeholder="xp_specific"></textarea>
            </div>
          </li>
          <input class="hider" type="hidden" name="attr_setting_extra_xp" value="0"/>
          <li>
            <div class="auto-expand"><span name="attr_xp_condition_extra"></span>
              <textarea spellcheck="false" name="attr_xp_condition_extra" data-i18n-placeholder="xp_specific_extra"></textarea>
            </div>
          </li>
          <li>
            <div class="auto-expand"><span name="attr_xp_condition2">You expressed your beliefs, drives, heritage, or background.</span>
              <textarea spellcheck="false" name="attr_xp_condition2">You expressed your beliefs, drives, heritage, or background.</textarea>
            </div>
          </li>
          <li>
            <div class="auto-expand"><span name="attr_xp_condition3">You struggled with issues from your vice or traumas during the session.</span>
              <textarea spellcheck="false" name="attr_xp_condition3">You struggled with issues from your vice or traumas during the session.</textarea>
            </div>
          </li>
        </ul>
      </div>
    </div>
    <!-- Right column-->
    <div class="col45 flex-wrap right-column">
      <!-- Clocks-->
      <div class="col100 clocks def-margin free-repcontrol">
        <div class="specialheader label" data-i18n="clocks"></div>
        <fieldset class="repeating_clock">
          <input class="size" type="hidden" name="attr_size" value=""/>
          <div class="auto-expand smallcaps"><span name="attr_name"></span>
            <textarea spellcheck="false" name="attr_name" data-i18n-placeholder="clock_name"></textarea>
          </div>
          <button class="broadcast-button" type="roll" name="roll_Show" value="&{template:bitd-broadcast} {{charname=@{character_name}}} {{title=@{name}}} {{clock=1}} {{clocksize=@{size}}} {{clockprogress=@{progress}}} {{charimage=@{chat_image}}}" data-i18n-title="send_details_to_chat">:</button>
          <div class="size-choice">
            <label class="text-button">
              <input type="radio" name="attr_size" value="4"/><span>4</span>
            </label>
            <label class="text-button">
              <input type="radio" name="attr_size" value="6"/><span>6</span>
            </label>
            <label class="text-button">
              <input type="radio" name="attr_size" value="8"/><span>8</span>
            </label>
            <label class="text-button">
              <input type="radio" name="attr_size" value="10"/><span>10</span>
            </label>
            <label class="text-button">
              <input type="radio" name="attr_size" value="12"/><span>12</span>
            </label>
          </div>
          <div class="clock-container">
            <div class="spoke-0 all"></div>
            <div class="spoke-30 sheet-12clock"></div>
            <div class="spoke-45 sheet-8clock"></div>
            <div class="spoke-36 sheet-10clock"></div>
            <div class="spoke-60 sheet-6clock sheet-12clock"></div>
            <div class="spoke-72 sheet-10clock"></div>
            <div class="spoke-90 sheet-4clock sheet-8clock sheet-12clock"></div>
            <div class="spoke-108 sheet-10clock"></div>
            <div class="spoke-120 sheet-6clock sheet-12clock"></div>
            <div class="spoke-135 sheet-8clock"></div>
            <div class="spoke-144 sheet-10clock"></div>
            <div class="spoke-150 sheet-12clock"></div>
            <input class="zero input-progress" type="radio" name="attr_progress" value="0" checked="checked"/><span></span>
            <input class="input-progress all" type="radio" name="attr_progress" value="1"/>
            <input class="input-progress all" type="radio" name="attr_progress" value="2"/>
            <input class="input-progress all" type="radio" name="attr_progress" value="3"/>
            <input class="input-progress all" type="radio" name="attr_progress" value="4"/>
            <input class="input-progress sheet-6clock sheet-8clock sheet-10clock sheet-12clock" type="radio" name="attr_progress" value="5"/>
            <input class="input-progress sheet-6clock sheet-8clock sheet-10clock sheet-12clock" type="radio" name="attr_progress" value="6"/>
            <input class="input-progress sheet-8clock sheet-10clock sheet-12clock" type="radio" name="attr_progress" value="7"/>
            <input class="input-progress sheet-8clock sheet-10clock sheet-12clock" type="radio" name="attr_progress" value="8"/>
            <input class="input-progress sheet-10clock sheet-12clock" type="radio" name="attr_progress" value="9"/>
            <input class="input-progress sheet-10clock sheet-12clock" type="radio" name="attr_progress" value="10"/>
            <input class="input-progress sheet-12clock" type="radio" name="attr_progress" value="11"/>
            <input class="input-progress sheet-12clock" type="radio" name="attr_progress" value="12"/>
            <div class="clock"></div>
          </div>
        </fieldset>
      </div>
      <textarea class="notes" spellcheck="false" name="attr_notes" data-i18n-placeholder="notes"></textarea>
    </div>
  </div>
</div>
<rolltemplate class="sheet-rolltemplate-bitd">
  <div class="holder{{#action}} action{{/action}}{{#resist}} resist{{/resist}}{{#vice}} vice{{/vice}}{{#fortune}} fortune{{/fortune}}{{#short}} short{{/short}}{{#action}}{{^position}} short{{/position}}{{/action}}">{{#charimage}}
    <div class="char-image">[Image]({{charimage}})</div>{{/charimage}}
    <div class="header{{#charimage}} narrow{{/charimage}}">{{charname}} {{subtitle}}</div>
    <div class="title"><span class="{{#small-title}}small-title{{/small-title}}">{{title}}</span></div>
    <div class="dice">{{^zerodice}}{{dice}}{{/zerodice}}{{#zerodice}}
      <div class="zerodice1">{{zerodice}}</div>
      <div class="zerodice2" data-i18n="zerodice"></div>{{/zerodice}}
    </div>{{#position}}
    <div class="position">{{position}}</div>{{/position}}{{#effect}}
    <div class="effect">{{effect}}</div>{{/effect}}{{#resist}}{{^short}}
    <div class="instructions" data-i18n="resist_instructions"></div>{{/short}}{{/resist}}{{#vice}}{{^short}}
    <div class="instructions" data-i18n="vice_instructions"></div>{{/short}}{{/vice}}{{#notes}}
    <div class="notes">{{notes}}</div>{{/notes}}
    <!-- Healing clock-->
    <input class="size" type="hidden" name="attr_recovery_max" value="8"/>
    <div class="clock-container">
      <div class="spoke-0 all"></div>
      <div class="spoke-45 all"></div>
      <div class="spoke-90 all"></div>
      <div class="spoke-135 all"></div>
      <input class="zero input-progress" type="radio" name="attr_recovery" value="0" checked="checked"/><span></span>
      <input class="input-progress all" type="radio" name="attr_recovery" value="1" data-i18n-title="recoveryblurb"/>
      <input class="input-progress all" type="radio" name="attr_recovery" value="2" data-i18n-title="recoveryblurb"/>
      <input class="input-progress all" type="radio" name="attr_recovery" value="3" data-i18n-title="recoveryblurb"/>
      <input class="input-progress all" type="radio" name="attr_recovery" value="4" data-i18n-title="recoveryblurb"/>
      <input class="input-progress all" type="radio" name="attr_recovery" value="5" data-i18n-title="recoveryblurb"/>
      <input class="input-progress all" type="radio" name="attr_recovery" value="6" data-i18n-title="recoveryblurb"/>
      <input class="input-progress all" type="radio" name="attr_recovery" value="7" data-i18n-title="recoveryblurb"/>
      <input class="input-progress all" type="radio" name="attr_recovery" value="8" data-i18n-title="recoveryblurb"/>
      <div class="clock"></div>
    </div>
  </div>
</rolltemplate>
<rolltemplate class="sheet-rolltemplate-bitd-broadcast">
  <div>{{#charimage}}{{^clock}}
    <div class="char-image">[Image]({{charimage}})</div>{{/clock}}{{/charimage}}
    <div class="header{{#charimage}}{{^clock}} narrow{{/clock}}{{/charimage}}">
      <div>{{charname}}</div>
      <div>{{type}}</div>
    </div>{{#content}}
    <div class="title">{{title}}</div>
    <div class="content">{{content}}</div>{{/content}}{{#clock}}
    <div class="flex">
      <div class="clock size-{{clocksize}} progress-{{clockprogress}}">
        <div class="spoke-0"></div>
        <div class="spoke-30"></div>
        <div class="spoke-36"></div>
        <div class="spoke-45"></div>
        <div class="spoke-60"></div>
        <div class="spoke-72"></div>
        <div class="spoke-90"></div>
        <div class="spoke-108"></div>
        <div class="spoke-135"></div>
        <div class="spoke-144"></div>
        <div class="spoke-120"></div>
        <div class="spoke-150"></div>
      </div>
      <div class="title">{{title}}</div>
    </div>{{/clock}}{{#harm}}
    <div class="title" data-i18n="harm"></div>
    <table class="harm">
      <tr>
        <td>3</td>
        <td>
          <div class="harm-inner">{{harm3}}</div>
        </td>
        <td data-i18n="need_help"></td>
      </tr>
      <tr>
        <td>2</td>
        <td>{{#harm2_1}}
          <div class="harm-inner">{{harm2_1}}</div>{{/harm2_1}}{{#harm2_2}}
          <div class="harm-inner">{{harm2_2}}</div>{{/harm2_2}}
        </td>
        <td data-i18n="minus1d"></td>
      </tr>
      <tr>
        <td>1</td>
        <td>{{#harm1_1}}
          <div class="harm-inner">{{harm1_1}}</div>{{/harm1_1}}{{#harm1_2}}
          <div class="harm-inner">{{harm1_2}}</div>{{/harm1_2}}
        </td>
        <td data-i18n="less_effect"></td>
      </tr>
    </table>{{/harm}}
  </div>
</rolltemplate>
<script type="text/worker">
"use strict";
const data = {
	"playbook": {
		"cutter": {
			"ability": ["battleborn", "bodyguard", "ghost_fighter", "leader", "mule", "not_to_be_trifled_with", "savage", "vigorous", "veteran"],
			"base": {
				"command": "1",
				"friends_title": "playbook_cutter_friends_title",
				"gatherinfo1": "gatherinfo_how_can_I_hurt",
				"gatherinfo2": "gatherinfo_whos_most_afraid",
				"gatherinfo3": "gatherinfo_whos_most_dangerous",
				"gatherinfo4": "gatherinfo_what_do_they_intend",
				"gatherinfo5": "gatherinfo_how_can_I_get_them",
				"gatherinfo6": "gatherinfo_are_they_telling",
				"playbook_description": "playbook_cutter_description",
				"skirmish": "2",
				"xp_condition": "playbook_cutter_xp_condition"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_hand_weapon",
				"numboxes": "1"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_heavy_weapon",
				"numboxes": "2"
			}, {
				"name": "playbook_item_scary_weapon_or_tool",
				"numboxes": "1"
			}, {
				"name": "playbook_item_manacles_&_chain",
				"numboxes": "0"
			}, {
				"name": "playbook_item_rage_essence_vial",
				"numboxes": "0"
			}, {
				"name": "playbook_item_spiritbane_charm",
				"numboxes": "0"
			}]
		},
		"ghost": {
			"ability": ["ghost_form", "dissipate", "manifest", "poltergeist", "possess", "veteran"],
			"base": {
				"friends_title": "playbook_ghost_friends_title",
				"gatherinfo1": "gatherinfo_what_do_they_intend",
				"gatherinfo2": "gatherinfo_how_can_I_get_them",
				"gatherinfo3": "gatherinfo_what_are_they_really",
				"gatherinfo4": "gatherinfo_what_should_I_look",
				"gatherinfo5": "gatherinfo_wheres_the_weakness",
				"gatherinfo6": "gatherinfo_how_can_I_find",
				"playbook_description": "playbook_ghost_description",
				"setting_stress_label": "drain",
				"setting_trauma_label": "gloom",
				"setting_traumata_set": "ghost",
				"setting_vice_type": "ghost",
				"xp_condition": "playbook_ghost_xp_condition",
				"xp_condition2": "playbook_ghost_xp_condition2",
				"xp_condition3": "playbook_ghost_xp_condition3"
			},
			"playbookitem": []
		},
		"hound": {
			"ability": ["sharpshooter", "focused", "ghost_hunter", "scout", "survivor", "tough_as_nails", "vengeful", "veteran"],
			"base": {
				"char_cohort_name": "hunting_pet",
				"char_cohort_subtype": "hunter",
				"friends_title": "playbook_hound_friends_title",
				"gatherinfo1": "gatherinfo_what_do_they_intend",
				"gatherinfo2": "gatherinfo_how_can_I_get_them",
				"gatherinfo3": "gatherinfo_what_are_they_really",
				"gatherinfo4": "gatherinfo_where_they_vulnerable",
				"gatherinfo5": "gatherinfo_where_did_x_go",
				"gatherinfo6": "gatherinfo_how_can_I_find",
				"hunt": "2",
				"playbook_description": "playbook_hound_description",
				"setting_show_cohort": "1",
				"survey": "1",
				"xp_condition": "playbook_hound_xp_condition"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_pair_of_pistols",
				"numboxes": "1"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_long_rifle",
				"numboxes": "2"
			}, {
				"name": "playbook_item_electroplasmic_ammunition",
				"numboxes": "1"
			}, {
				"name": "playbook_item_a_trained_hunting_pet",
				"numboxes": "0"
			}, {
				"name": "playbook_item_spyglass",
				"numboxes": "1"
			}, {
				"name": "playbook_item_spiritbane_charm",
				"numboxes": "0"
			}]
		},
		"hull": {
			"ability": ["automaton", "overcharge", "compartments", "electroplasmic_projectors", "interface", "secondary_hull", "frame_upgrade"],
			"base": {
				"gatherinfo1": "gatherinfo_what_do_they_intend",
				"gatherinfo2": "gatherinfo_how_can_I_get_them",
				"gatherinfo3": "gatherinfo_what_are_they_really",
				"gatherinfo4": "gatherinfo_what_should_I_look",
				"gatherinfo5": "gatherinfo_wheres_the_weakness",
				"gatherinfo6": "gatherinfo_how_can_I_find",
				"playbook_description": "playbook_hull_description",
				"setting_load_h": "7",
				"setting_extra_stress": "1",
				"setting_show_frame": "1",
				"setting_stress_label": "drain",
				"setting_trauma_label": "wear",
				"setting_traumata_set": "hull",
				"setting_vice_type": "hull",
				"xp_condition": "playbook_hull_xp_condition",
				"xp_condition2": "playbook_hull_xp_condition2",
				"xp_condition3": "playbook_hull_xp_condition3"
			},
			"playbookitem": []
		},
		"leech": {
			"ability": ["alchemist", "analyst", "artificer", "fortitude", "ghost_ward", "physicker", "saboteur", "venomous", "veteran"],
			"base": {
				"friends_title": "playbook_leech_friends_title",
				"gatherinfo1": "gatherinfo_what_do_they_intend",
				"gatherinfo2": "gatherinfo_how_can_I_get_them",
				"gatherinfo3": "gatherinfo_are_they_telling",
				"gatherinfo4": "gatherinfo_what_can_I_tinker",
				"gatherinfo5": "gatherinfo_what_might_happen",
				"gatherinfo6": "gatherinfo_how_can_I_find",
				"playbook_description": "playbook_leech_description",
				"tinker": "2",
				"wreck": "1",
				"xp_condition": "playbook_leech_xp_condition"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_tinkering_tools",
				"numboxes": "1"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_wrecking_tools",
				"numboxes": "2"
			}, {
				"name": "playbook_item_blowgun_&_darts,_syringes",
				"numboxes": "0"
			}, {
				"name": "playbook_item_bandolier_of_alchemicals_(3)",
				"numboxes": "1"
			}, {
				"name": "playbook_item_bandolier_of_alchemicals_(3)",
				"numboxes": "1"
			}, {
				"name": "playbook_item_gadget",
				"numboxes": "1"
			}]
		},
		"lurk": {
			"ability": ["infiltrator", "ambush", "daredevil", "the_devil's_footsteps", "expertise", "ghost_veil", "reflexes", "shadow", "veteran"],
			"base": {
				"friends_title": "playbook_lurk_friends_title",
				"finesse": "1",
				"gatherinfo1": "gatherinfo_what_do_they_intend",
				"gatherinfo2": "gatherinfo_how_can_I_get_them",
				"gatherinfo3": "gatherinfo_what_should_I_look",
				"gatherinfo4": "gatherinfo_whats_the_best_way",
				"gatherinfo5": "gatherinfo_where_can_I_hide",
				"gatherinfo6": "gatherinfo_how_can_I_find",
				"playbook_description": "playbook_lurk_description",
				"prowl": "2",
				"xp_condition": "playbook_lurk_xp_condition"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_lockpicks",
				"numboxes": "0"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_shadow_cloak",
				"numboxes": "1"
			}, {
				"name": "playbook_item_light_climbing_gear",
				"numboxes": "1"
			}, {
				"name": "playbook_item_silence_potion_vial",
				"numboxes": "0"
			}, {
				"name": "playbook_item_dark-sight_goggles",
				"numboxes": "1"
			}, {
				"name": "playbook_item_spiritbane_charm",
				"numboxes": "0"
			}]
		},
		"slide": {
			"ability": ["rook's_gambit", "cloak_&_dagger", "ghost_voice", "like_looking_into_a_mirror", "a_little_something_on_the_side", "mesmerism", "subterfuge", "trust_in_me", "veteran"],
			"base": {
				"friends_title": "playbook_slide_friends_title",
				"consort": "1",
				"gatherinfo1": "gatherinfo_what_do_they_intend",
				"gatherinfo2": "gatherinfo_how_can_I_get_them",
				"gatherinfo3": "gatherinfo_are_they_telling",
				"gatherinfo4": "gatherinfo_what_are_they_really",
				"gatherinfo5": "gatherinfo_what_do_they_really",
				"gatherinfo6": "gatherinfo_how_can_I_blend",
				"playbook_description": "playbook_slide_description",
				"sway": "2",
				"xp_condition": "playbook_slide_xp_condition"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_clothes_&_jewelry",
				"numboxes": "0"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_disguise_kit",
				"numboxes": "1"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_loaded_dice,_trick_cards",
				"numboxes": "0"
			}, {
				"name": "playbook_item_trance_powder",
				"numboxes": "0"
			}, {
				"name": "playbook_item_a_cane-sword",
				"numboxes": "1"
			}, {
				"name": "playbook_item_spiritbane_charm",
				"numboxes": "0"
			}]
		},
		"spider": {
			"ability": ["foresight", "calculating", "connected", "functioning_vice", "ghost_contract", "jail_bird", "mastermind", "weaving_the_web", "veteran"],
			"base": {
				"consort": "2",
				"friends_title": "playbook_spider_friends_title",
				"gatherinfo1": "gatherinfo_what_do_they_want",
				"gatherinfo2": "gatherinfo_what_should_I_look",
				"gatherinfo3": "gatherinfo_wheres_the_leverage",
				"gatherinfo4": "gatherinfo_how_can_I_discover",
				"gatherinfo5": "gatherinfo_what_do_they_intend",
				"gatherinfo6": "gatherinfo_how_can_I_get_them",
				"playbook_description": "playbook_spider_description",
				"study": "1",
				"xp_condition": "playbook_spider_xp_condition"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_cover_identity",
				"numboxes": "0"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_bottle_of_whiskey",
				"numboxes": "1"
			}, {
				"name": "playbook_item_blueprints",
				"numboxes": "1"
			}, {
				"name": "playbook_item_vial_of_slumber_essence",
				"numboxes": "0"
			}, {
				"name": "playbook_item_concealed_palm_pistol",
				"numboxes": "0"
			}, {
				"name": "playbook_item_spiritbane_charm",
				"numboxes": "0"
			}]
		},
		"whisper": {
			"ability": ["compel", "ghost_mind", "iron_will", "occultist", "ritual", "strange_methods", "tempest", "warded"],
			"base": {
				"attune": "2",
				"friends_title": "playbook_whisper_friends_title",
				"gatherinfo1": "gatherinfo_what_is_arcane",
				"gatherinfo2": "gatherinfo_what_echoes",
				"gatherinfo3": "gatherinfo_what_is_hidden",
				"gatherinfo4": "gatherinfo_what_do_they_intend",
				"gatherinfo5": "gatherinfo_what_drives_them",
				"gatherinfo6": "gatherinfo_how_can_I_reveal",
				"playbook_description": "playbook_whisper_description",
				"study": "1",
				"xp_condition": "playbook_whisper_xp_condition"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_lightning_hook",
				"numboxes": "1"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_spirit_mask",
				"numboxes": "1"
			}, {
				"name": "playbook_item_electroplasm_vials",
				"numboxes": "0"
			}, {
				"name": "playbook_item_spirit_bottles_(2)",
				"numboxes": "1"
			}, {
				"name": "playbook_item_ghost_key",
				"numboxes": "0"
			}, {
				"name": "playbook_item_demonbane_charm",
				"numboxes": "0"
			}]
		},
		"vampire": {
			"ability": ["undead", "terrible_power", "arcane_sight", "a_void_in_the_echo", "dark_talent", "sinister_guile", "veteran"],
			"base": {
				"friends_title": "playbook_vampire_friends_title",
				"gatherinfo1": "gatherinfo_what_do_they_intend",
				"gatherinfo2": "gatherinfo_how_can_I_get_them",
				"gatherinfo3": "gatherinfo_what_are_they_really",
				"gatherinfo4": "gatherinfo_what_should_I_look",
				"gatherinfo5": "gatherinfo_wheres_the_weakness",
				"gatherinfo6": "gatherinfo_how_can_I_find",
				"playbook_description": "playbook_vampire_description",
				"setting_extra_stress": "3",
				"setting_show_strictures": "1",
				"setting_vice_type": "vampire",
				"trauma": "4",
				"xp_condition": "playbook_vampire_xp_condition",
				"xp_condition2": "playbook_vampire_xp_condition2",
				"xp_condition3": "playbook_vampire_xp_condition3"
			},
			"playbookitem": [{
				"bold": "1",
				"name": "playbook_item_fine_clothes_and_accoutrements",
				"numboxes": "0"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_personal_weapon",
				"numboxes": "1"
			}, {
				"bold": "1",
				"name": "playbook_item_fine_shadow_cloak",
				"numboxes": "1"
			}, {
				"name": "playbook_item_demonbane_charm",
				"numboxes": "0"
			}, {
				"name": "playbook_item_spiritbane_charm",
				"numboxes": "0"
			}]
		}
	},
	"actions": {
		"insight": ["hunt", "study", "survey", "tinker"],
		"prowess": ["finesse", "prowl", "skirmish", "wreck"],
		"resolve": ["attune", "command", "consort", "sway"]
	},
	"traumas": {
		"normal": ["cold", "haunted", "obsessed", "paranoid", "reckless", "soft", "unstable", "vicious"],
		"ghost": ["chaotic", "destructive", "furious", "obsessive", "territorial", "savage"],
		"hull": ["clanking", "leaking", "fixated", "smoking", "sparking", "unstable"]
	},
	"items": [{
		"name": "a_blade_or_two",
		"description": "a_blade_or_two_description",
		"numboxes": "1"
	}, {
		"name": "throwing_knives",
		"description": "throwing_knives_description",
		"numboxes": "1"
	}, {
		"name": "a_pistol",
		"description": "a_pistol_description",
		"numboxes": "1",
		"short": "1"
	}, {
		"name": "a_2nd_pistol",
		"description": "a_pistol_description",
		"numboxes": "1",
		"short": "1"
	}, {
		"name": "a_large_weapon",
		"description": "a_large_weapon_description",
		"numboxes": "2"
	}, {
		"name": "an_unusual_weapon",
		"description": "an_unusual_weapon_description",
		"numboxes": "1"
	}, {
		"name": "armor",
		"description": "armor_description",
		"numboxes": "2",
		"short": "1"
	}, {
		"name": "+heavy",
		"description": "+heavy_description",
		"numboxes": "3",
		"short": "1"
	}, {
		"name": "burglary_gear",
		"description": "burglary_gear_description",
		"numboxes": "1"
	}, {
		"name": "climbing_gear",
		"description": "climbing_gear_description",
		"numboxes": "2"
	}, {
		"name": "arcane_implements",
		"description": "arcane_implements_description",
		"numboxes": "1"
	}, {
		"name": "documents",
		"description": "documents_description",
		"numboxes": "1"
	}, {
		"name": "subterfuge_supplies",
		"description": "subterfuge_supplies_description",
		"numboxes": "1"
	}, {
		"name": "demolition_tools",
		"description": "demolition_tools_description",
		"numboxes": "2"
	}, {
		"name": "tinkering_tools",
		"description": "tinkering_tools_description",
		"numboxes": "1"
	}, {
		"name": "lantern",
		"description": "lantern_description",
		"numboxes": "1"
	}],
	"alchemicals": ["alcahest", "binding_oil", "drift_oil", "drown_powder", "eyeblind_poison", "fire_oil", "grenade", "quicksilver", "skullfire_poison", "smoke_bomb", "spark_drug", "standstill_poison", "trance_powder"],
	"translatedDefaults": {
		"cohort1_name": "cohort",
		"contacts_title": "contacts",
		"factions_title": "factions_title",
		"factions1_header": "factions1",
		"factions2_header": "factions2",
		"factions3_header": "factions3",
		"factions4_header": "factions4",
		"factions5_header": "factions5",
		"friends_title": "friends",
		"setting_stress_label": "stress",
		"setting_trauma_label": "trauma",
		"upgrade_6_name": "carriage",
		"upgrade_6_description": "upgrade_carriage_description",
		"upgrade_7_name": "documents",
		"upgrade_7_description": "upgrade_documents_description",
		"upgrade_8_name": "boat",
		"upgrade_8_description": "upgrade_boat_description",
		"upgrade_9_name": "gear",
		"upgrade_9_description": "upgrade_gear_description",
		"upgrade_10_name": "hidden",
		"upgrade_10_description": "upgrade_hidden_description",
		"upgrade_11_name": "implements",
		"upgrade_11_description": "upgrade_implements_description",
		"upgrade_12_name": "quarters",
		"upgrade_12_description": "upgrade_quarters_description",
		"upgrade_13_name": "supplies",
		"upgrade_13_description": "upgrade_supplies_description",
		"upgrade_14_name": "secure",
		"upgrade_14_description": "upgrade_secure_description",
		"upgrade_15_name": "tools",
		"upgrade_15_description": "upgrade_tools_description",
		"upgrade_16_name": "vault",
		"upgrade_16_description": "upgrade_vault_description",
		"upgrade_17_name": "weapons",
		"upgrade_17_description": "upgrade_weapons_description",
		"upgrade_18_name": "workshop",
		"upgrade_18_description": "upgrade_workshop_description",
		"upgrade_20_name": "insight",
		"upgrade_20_description": "upgrade_insight_description",
		"upgrade_21_name": "prowess",
		"upgrade_21_description": "upgrade_prowess_description",
		"upgrade_22_name": "resolve",
		"upgrade_22_description": "upgrade_resolve_description",
		"upgrade_23_name": "personal",
		"upgrade_23_description": "upgrade_personal_description",
		"upgrade_24_name": "mastery",
		"upgrade_24_description": "upgrade_mastery_description",
		"xp_condition2": "xp_beliefs",
		"xp_condition3": "xp_vice"
	},
	"defaultValues": {
		"attune": "0",
		"claim_bridge_10_15": "1",
		"claim_bridge_12_13": "1",
		"claim_bridge_13_14": "1",
		"claim_bridge_2_3": "1",
		"claim_bridge_2_7": "1",
		"claim_bridge_3_4": "1",
		"claim_bridge_4_9": "1",
		"claim_bridge_6_11": "1",
		"claim_bridge_6_7": "1",
		"claim_bridge_9_14": "1",
		"cohort1_subtype": "",
		"cohort1_type": "gang",
		"command": "0",
		"consort": "0",
		"finesse": "0",
		"hunt": "0",
		"prowl": "0",
		"setting_extra_stress": "0",
		"setting_load_h": "6",
		"setting_show_deity": "0",
		"setting_show_frame": "0",
		"setting_show_origin": "0",
		"setting_show_strictures": "0",
		"setting_traumata_set": "normal",
		"setting_vice_type": "normal",
		"skirmish": "0",
		"study": "0",
		"survey": "0",
		"sway": "0",
		"tinker": "0",
		"trauma": "0",
		"upgrade_10_check_1": "0",
		"upgrade_14_check_1": "0",
		"upgrade_20_check_1": "0",
		"upgrade_21_check_1": "0",
		"upgrade_22_check_1": "0",
		"upgrade_6_check_1": "0",
		"wreck": "0"
	},
	"maxFriendsPerPlaybook": 5,
	"maxContactsPerCrew": 6,
	"friendlessPlaybooks": ["ghost", "hull"],
	"translatedCrewAttributes": ["claim_1_name", "claim_2_name", "claim_3_name", "claim_4_name", "claim_5_name", "claim_6_name", "claim_7_name", "claim_8_name", "claim_9_name", "claim_10_name", "claim_11_name", "claim_12_name", "claim_13_name", "claim_14_name", "claim_15_name", "claim_1_desc", "claim_2_desc", "claim_3_desc", "claim_4_desc", "claim_5_desc", "claim_6_desc", "claim_7_desc", "claim_8_desc", "claim_9_desc", "claim_10_desc", "claim_11_desc", "claim_12_desc", "claim_13_desc", "claim_14_desc", "claim_15_desc", "cohort1_description", "cohort1_name", "cohort1_subtype", "crew_description", "crew_xp_condition", "hunting_grounds_type", "hunting_grounds_description", "upgrade_6_name", "upgrade_8_name"],
	"translatedPlaybookAttributes": ["char_cohort_name", "char_cohort_subtype", "friends_title", "gatherinfo1", "gatherinfo2", "gatherinfo3", "gatherinfo4", "gatherinfo5", "gatherinfo6", "playbook_description", "setting_stress_label", "setting_trauma_label", "xp_condition", "xp_condition2", "xp_condition3"]
};
/* global data, getTranslationByKey, getAttrs, setAttrs, on, getSectionIDs, generateRowID, removeRepeatingRow */
const sheetVersion = "1.0";
const sheetName = "Blades in the Dark";
const getTranslation = (key) => (getTranslationByKey(key) || "NO_TRANSLATION_FOUND");
/* It's necessary to include the base data at the start of the file */
/* Translate all the data */
Object.keys(data.crew).forEach(crew => {
	const base = data.crew[crew].base;
	Object.keys(base).forEach(attr => {
		if (data.translatedCrewAttributes.includes(attr)) {
			base[attr] = getTranslation(base[attr]);
		}
	});
});
data.items.forEach(item => {
	item.boxes_chosen = "1";
	item.name = getTranslation(item.name);
	item.description = getTranslationByKey(item.description) || "";
});
Object.keys(data.translatedDefaults).forEach(k => {
	data.translatedDefaults[k] = getTranslation(data.translatedDefaults[k]);
});
Object.assign(data.defaultValues, data.translatedDefaults);
Object.keys(data.factions).forEach(x => {
	data.factions[x].forEach(faction => {
		faction.name = getTranslation(faction.name);
	});
});
data.alchemicals.forEach((v, k) => {
	data.alchemicals[k] = {
		name: getTranslation(v)
	};
});
Object.keys(data.playbook).forEach(playbook => {
	const base = data.playbook[playbook].base;
	Object.keys(base).forEach(attr => {
		if (data.translatedPlaybookAttributes.includes(attr)) {
			base[attr] = getTranslation(base[attr]);
		}
	});
	/* Generate playbook friends from translation file */
	if (!data.friendlessPlaybooks.includes(playbook)) {
		data.playbook[playbook].friend = [...Array(data.maxFriendsPerPlaybook).keys()]
			.map(i => ({
				name: getTranslation(`playbook_${playbook}_friend_${i}`)
			}))
			.filter(o => o.name);
	}
	else data.playbook[playbook].friend = [];
	data.playbook[playbook].ability = data.playbook[playbook].ability.map(name => ({
		name: getTranslation(`playbook_ability_${name}`),
		description: getTranslation(`playbook_ability_${name}_description`)
	}));
	data.playbook[playbook].playbookitem.forEach(item => {
		item.name = getTranslation(item.name);
		if (item.description) {
			item.description = getTranslationByKey(item.description) || "";
		}
		item.boxes_chosen = "1";
	});
});
const playbookAbilityMap = new Map([...Object.values(data.playbook).map(x => x.ability).reduce((m, v) => {
	v.forEach(a => m.add(a));
	return m;
}, new Set())].map(x => {
	return [x.name.toLowerCase(), x.description];
}));
/* Utility functions - shouldn't need to touch most of these */
const mySetAttrs = (attrs, options, callback) => {
		const finalAttrs = Object.keys(attrs).reduce((m, k) => {
			m[k] = String(attrs[k]);
			return m;
		}, {});
		setAttrs(finalAttrs, options, callback);
	},
	setAttr = (name, value) => {
		getAttrs([name], v => {
			const setting = {};
			if (v[name] !== String(value)) setting[name] = String(value);
			setAttrs(setting);
		});
	},
	fillRepeatingSectionFromData = (sectionName, dataList, autogen, callback) => {
		callback = callback || (() => {});
		getSectionIDs(`repeating_${sectionName}`, idList => {
			const existingRowAttributes = [
				...idList.map(id => `repeating_${sectionName}_${id}_name`),
				...idList.map(id => `repeating_${sectionName}_${id}_autogen`)
			];
			getAttrs(existingRowAttributes, v => {
				/* Delete auto-generated rows */
				if (autogen) {
					idList = idList.filter(id => {
						if (v[`repeating_${sectionName}_${id}_autogen`]) {
							removeRepeatingRow(`repeating_${sectionName}_${id}`);
							return false;
						}
						else return true;
					});
				}
				const existingRowNames = idList.map(id => v[`repeating_${sectionName}_${id}_name`]),
					createdIDs = [],
					setting = dataList.filter(o => !existingRowNames.includes(o.name))
						.map(o => {
							let rowID;
							while (!rowID) {
								let newID = generateRowID();
								if (!createdIDs.includes(newID)) {
									rowID = newID;
									createdIDs.push(rowID);
								}
							}
							const newAttrs = {};
							if (autogen) {
								newAttrs[`repeating_${sectionName}_${rowID}_autogen`] = "1";
							}
							return Object.keys(o).reduce((m, key) => {
								m[`repeating_${sectionName}_${rowID}_${key}`] = o[key];
								return m;
							}, newAttrs);
						})
						.reduce((m, o) => Object.assign(m, o), {});
				mySetAttrs(setting, {}, callback);
			});
		});
	},
	diceMagic = num => {
		const range = end => [...Array(end + 1).keys()].slice(1);
		if (num > 0) return `dice=${range(num).map(() => "[[d6]]").join("&"+"#44"+"; ")}`;
		else return "zerodice=[[d6]]&"+"#44"+"; [[d6]]";
	},
	buildRollFormula = base => {
		return ` {{?{@{bonusdice}|${
			[0, 1, 2, 3, 4, 5, 6, -1, -2, -3].map(n => `${n},${diceMagic(n + (parseInt(base) || 0))}`).join("|")
		}}}}`;
	},
	buildNumdiceFormula = () => {
		return ` {{?{${getTranslation("numberofdice")}|${
			[0, 1, 2, 3, 4, 5, 6].map(n => `${n},${diceMagic(n)}`).join("|")
		}}}}`;
	},
	emptyFirstRowIfUnnamed = sectionName => {
		getSectionIDs(`repeating_${sectionName}`, idList => {
			const id = idList[0];
			getAttrs([`repeating_${sectionName}_${id}_name`], v => {
				if (!v[`repeating_${sectionName}_${id}_name`]) {
					removeRepeatingRow(`repeating_${sectionName}_${id}`);
				}
			});
		});
	},
	handleBoxesFill = (name, upToFour) => {
		on(`change:${name}1 change:${name}2 change:${name}3 change:${name}4`, event => {
			if (event.sourceType !== "player") return;
			getAttrs([event.sourceAttribute], v => {
				const rName = event.sourceAttribute.slice(0, -1),
					setting = {};
				if (String(v[event.sourceAttribute]) === "1") {
					switch (event.sourceAttribute.slice(-1)) {
					case "4":
						setting[`${rName}3`] = 1;
						/* falls through */
					case "3":
						setting[`${rName}2`] = 1;
						/* falls through */
					case "2":
						setting[`${rName}1`] = 1;
					}
				}
				if (String(v[event.sourceAttribute]) === "0") {
					switch (event.sourceAttribute.slice(-1)) {
					case "1":
						setting[`${rName}2`] = 0;
						/* falls through */
					case "2":
						setting[`${rName}3`] = 0;
						/* falls through */
					case "3":
						if (upToFour) setting[`${rName}4`] = 0;
					}
				}
				mySetAttrs(setting);
			});
		});
	});
/* CONSTANTS */
const playbookAttributes = [...new Set([].concat(...Object.keys(data.playbook).map(x => Object.keys(data.playbook[x].base))))],
	watchedAttributes = new Set(crewAttributes.concat(playbookAttributes)),
	actionsFlat = [].concat(...Object.keys(data.actions).map(x => data.actions[x])),
	traumaDataFlat = Object.keys(data.traumas).reduce((m, k) => m.concat(data.traumas[k]), []),
	autoExpandFields = [
		"repeating_ability:name",
		"repeating_ability:description",
		"repeating_crewability:name",
		"repeating_crewability:description",
		"repeating_playbookitem:name",
		"repeating_upgrade:name",
		"repeating_friend:name",
		"repeating_contact:name",
		"repeating_clock:name",
		"repeating_crewclock:name",
		"repeating_factionclock:name",
		"repeating_cohort:edges",
		"repeating_cohort:flaws",
		"repeating_alchemical:name",
		"xp_condition",
		"xp_condition_extra",
		"xp_condition2",
		"xp_condition3",
		"crew_xp_condition",
		"hunting_grounds_type",
		"hunting_grounds_description",
		"cohort1_edges",
		"cohort1_flaws",
		"heritage",
		"background",
		"vice_purveyor",
	],
	autogenSections = [
		"ability",
		"crewability",
		"friend",
		"contact",
		"playbookitem",
		"upgrade"
	],
	spiritPlaybooks = ["ghost", "hull", "vampire"],
	translatedNames = [...Object.keys(data.playbook), ...Object.keys(data.crew)].reduce((m, keyName) => {
		if (getTranslationByKey(keyName)) m[getTranslationByKey(keyName).toLowerCase()] = keyName;
		else m[keyName.toLowerCase()] = keyName;
		return m;
	}, {});
/* EVENT HANDLERS */
/* Set default fields when setting crew type or playbook */
on("change:playbook", event => {
	getAttrs(["playbook", "changed_attributes", "setting_autofill", ...watchedAttributes], v => {
		const changedAttributes = (v.changed_attributes || "").split(","),
			sourceName = translatedNames[(event.sourceAttribute).toLowerCase()],
			fillBaseData = (inputData, defaultAttrNames) => {
				if (data) {
					const finalSettings = defaultAttrNames.filter(name => !changedAttributes.includes(name))
						// do not reset attributes which have been changed by the user
						.filter(name => !spiritPlaybooks.includes(sourceName) || !actionsFlat.includes(name))
						// do not reset action dots if changing to a spirit playbook
						.filter(name => v[name] !== (data.defaultValues[name] || ""))
						// do not set attributes if current value is equal to sheet defaults
						.reduce((m, name) => {
							m[name] = data.defaultValues[name] || "";
							return m;
						}, {});
					Object.keys(inputData).filter(name => !changedAttributes.includes(name))
						.forEach(name => (finalSettings[name] = inputData[name]));
					mySetAttrs(finalSettings);
				}
			};
		if (v.setting_autofill !== "1") return;
		if (event.sourceAttribute === "crew_type" && sourceName in data.crew) {
			fillRepeatingSectionFromData("contact", data.crew[sourceName].contact, true);
			fillRepeatingSectionFromData("crewability", data.crew[sourceName].crewability, true);
			fillRepeatingSectionFromData("upgrade", data.crew[sourceName].upgrade, true);
			fillBaseData(data.crew[sourceName].base, crewAttributes);
		}
		if (event.sourceAttribute === "playbook" && sourceName in data.playbook) {
			fillRepeatingSectionFromData("friend", data.playbook[sourceName].friend, true);
			fillRepeatingSectionFromData("ability", data.playbook[sourceName].ability, true);
			fillRepeatingSectionFromData("playbookitem", data.playbook[sourceName].playbookitem, true);
			fillBaseData(data.playbook[sourceName].base, playbookAttributes);
			if (sourceName === "leech") fillRepeatingSectionFromData("alchemical", data.alchemicals);
		}
	});
});
const fillPlaybookAbility = () => {
	const prefix = "repeating_ability";
	getAttrs([`${prefix}_name`, `${prefix}_description`], v => {
		if (!v[`${prefix}_description`]) {
			const description = playbookAbilityMap.get((v[`${prefix}_name`] || "").toLowerCase());
			if (description) setAttr(`${prefix}_description`, description);
		}
	});
};
const fillCrewAbility = () => {
	const prefix = "repeating_crewability";
	getAttrs([`${prefix}_name`, `${prefix}_description`], v => {
		if (!v[`${prefix}_description`]) {
			const description = crewAbilityMap.get((v[`${prefix}_name`] || "").toLowerCase());
			if (description) setAttr(`${prefix}_description`, description);
		}
	});
};
on("change:repeating_ability:name", fillPlaybookAbility);
on("change:repeating_crewability:name", fillCrewAbility);
/* Watch repeating rows for changes and set autogen to false if change happens */
autogenSections.forEach(sectionName => {
	on(`change:repeating_${sectionName}`, event => {
		getAttrs([`repeating_${sectionName}_autogen`], v => {
			if (v[`repeating_${sectionName}_autogen`] && event.sourceType === "player") {
				setAttr(`repeating_${sectionName}_autogen`, "");
			}
		});
	});
});
/* Watch for changes in auto-set attributes and update changed_attributes*/
watchedAttributes.forEach(name => {
	on(`change:${name}`, event => {
		if (event.sourceType === "player") {
			getAttrs(["changed_attributes"], v => {
				const changedAttributes = [...new Set(v.changed_attributes.split(",")).add(name)]
					.filter(x => !!x).join(",");
				setAttr("changed_attributes", changedAttributes);
			});
		}
	});
});
/* Register attribute/action event handlers */
Object.keys(data.actions).forEach(attrName => {
	on([...data.actions[attrName], `setting_resbonus_${attrName}`]
		.map(x => `change:${x}`).join(" "), () => calculateResistance(attrName)
	);
	on(`change:${attrName}`, calculateVice);
});
/* Calculate stash */
on("change:stash", calculateStashFormula);
on("change:wanted", calculateWantedFormula);
/* Calculate trauma */
on("change:setting_traumata_set " + traumaDataFlat.map(x => `change:trauma_${x}`).join(" "), event => {
	getAttrs(["setting_traumata_set", ...traumaDataFlat.map(x => `trauma_${x}`)], v => {
		const traumaType = (v.setting_traumata_set === "0" ? "normal" : v.setting_traumata_set);
		if (data.traumas[traumaType] && event.sourceType === "player") {
			const newTrauma = data.traumas[traumaType].reduce((m, name) => m + (parseInt(v[`trauma_${name}`]) || 0), 0);
			setAttr("trauma", newTrauma);
		}
	});
});
/* Generate buttons */
on("change:generate_factions", () => {
	setAttr("show_faction_generatebutton", "0");
	Object.keys(data.factions).forEach(sectionName => {
		fillRepeatingSectionFromData(sectionName, data.factions[sectionName]);
	});
});
autogenSections.forEach(sectionName => {
	on(`change:generate_${sectionName}`, () => {
		getAttrs(["generate_source_character", "generate_source_crew", "sheet_type"], v => {
			const dataVar = (v.sheet_type === "character") ? data.playbook : data.crew,
				genSource = v[`generate_source_${v.sheet_type}`];
			if (genSource in dataVar) {
				emptyFirstRowIfUnnamed(sectionName);
				fillRepeatingSectionFromData(sectionName, dataVar[genSource][sectionName]);
			}
		});
	});
});
/* Extra stress and trauma */
on("change:setting_extra_stress", event => setAttr("stress_max", 9 + (parseInt(event.newValue) || 0)));
on("change:setting_extra_trauma", event => setAttr("trauma_max", 4 + (parseInt(event.newValue) || 0)));
/* Calculate cohort quality */
on(["crew_tier", "cohort1_impaired", "cohort1_type"].map(x => `change:${x}`).join(" "), () => calculateCohortDice(["cohort1"]));
on("change:repeating_cohort", () => calculateCohortDice(["repeating_cohort"]));
on("change:crew_tier", () => {
	getSectionIDs("repeating_cohort", a => calculateCohortDice(a.map(id => `repeating_cohort_${id}`)));
});
on("change:char_cohort_quality change:char_cohort_impaired change:setting_show_cohort", () => {
	getAttrs(["char_cohort_quality", "char_cohort_impaired"], v => {
		const dice = (parseInt(v.char_cohort_quality) || 0) - (parseInt(v.char_cohort_impaired) || 0);
		setAttr("char_cohort_roll_formula", buildRollFormula(dice));
	});
});
/* Set correct verb for cohort roll button */
["char_cohort", "cohort1", "repeating_cohort"].forEach(prefix => {
	const eventString = "change:" + ((prefix === "repeating_cohort") ? `${prefix}:type` : `${prefix}_type`);
	on(eventString, event => {
		const verb = (event.newValue === "expert") ? "^{rolls_their}" : "^{roll_their}";
		setAttr(`${prefix}_verb`, verb);
	});
});
/* Left-fill checkboxes */
handleBoxesFill("upgrade_24_check_", true);
handleBoxesFill("bandolier1_check_");
handleBoxesFill("bandolier2_check_");
["item", "playbookitem", "upgrade"].forEach(sName => handleBoxesFill(`repeating_${sName}:check_`));
/* Pseudo-radios */
["crew_tier", ...actionsFlat].forEach(name => {
	on(`change:${name}`, event => {
		if (String(event.newValue) === "0" && event.sourceType === "player") {
			setAttr(name, (parseInt(event.previousValue) || 1) - 1);
		}
		setAttr(`${name}_formula`, buildRollFormula(event.newValue || "0"));
	});
});
/* Item reset button */
on("change:reset_items", () => {
	const clearChecks = sectionName => {
		getSectionIDs(`repeating_${sectionName}`, idArray => {
			const setting = [
				...idArray.map(id => `repeating_${sectionName}_${id}_check_1`),
				...idArray.map(id => `repeating_${sectionName}_${id}_check_2`),
				...idArray.map(id => `repeating_${sectionName}_${id}_check_3`)
			].reduce((m, name) => {
				m[name] = 0;
				return m;
			}, {});
			mySetAttrs(setting);
		});
	};
	setAttr("load", 0);
	["item", "playbookitem"].forEach(clearChecks);
});
/* Default values for number of upgrades boxes — probably not necessary anymore */
// on('change:repeating_upgrade:boxes_chosen', () => {
// 	getAttrs(['repeating_upgrade_numboxes'], v => {
// 		if (!['1', '2', '3'].includes(v.repeating_upgrade_numboxes)) {
// 			setAttr('repeating_upgrade_numboxes', '1');
// 		}
// 	});
// });
/* Resistance query */
on("change:setting_consequence_query sheet:opened", () => {
	getAttrs(["setting_consequence_query"], v => {
		const consequenceQuery = (String(v.setting_consequence_query) === "1") ?
			`?{${getTranslation("consequence")}|${getTranslation("a_consequence")}}` :
			"^{a_consequence}";
		setAttr("consequence_query", consequenceQuery);
	});
});
/* Trim whitespace in auto-expand fields */
autoExpandFields.forEach(name => {
	on(`change:${name}`, event => {
		const attrName = name.replace(":", "_");
		getAttrs([attrName], v => {
			if (v[attrName].trim() !== v[attrName] && event.sourceType === "player") {
				setAttr(attrName, v[attrName].trim());
			}
		});
	});
});
/* Clean chat image URL */
on("change:chat_image", event => {
	const match = (event.newValue || "").match(/^(https:\/\/s3\.amazonaws\.com\/files\.d20\.io\/images\/.*\.jpg)\?\d+$/);
	if (match) setAttr("chat_image", match[1]);
});
/* Number of dice prompt */
on("sheet:opened", () => {
	/* Set up translated attributes */
	const translatedAttrs = {
		bonusdice: getTranslation("bonusdice"),
		effect_query: getTranslation("effect_query"),
		notes_query: `?{${getTranslation("notes")}}`,
		numberofdice: buildNumdiceFormula(),
		position_query: `?{${getTranslation("position")}|` +
			`${getTranslation("risky")},position=${getTranslation("risky")}|` +
			`${getTranslation("controlled")},position=${getTranslation("controlled")}|` +
			`${getTranslation("desperate")},position=${getTranslation("desperate")}|` +
			`${getTranslation("fortune_roll")},position=}`,
	};
	getAttrs(Object.keys(translatedAttrs), v => {
		const setting = {};
		Object.keys(translatedAttrs).forEach(name => {
			if (v[name] !== translatedAttrs[name]) setting[name] = translatedAttrs[name];
		});
		mySetAttrs(setting);
	});
});
/* INITIALISATION AND UPGRADES */
on("sheet:opened", () => {
	getAttrs(["sheet_type", "changed_attributes", "crew_type", "playbook"], v => {
		/* Make sure sheet_type is never 0 */
		if (!["crew", "faction"].includes(v.sheet_type)) setAttr("sheet_type", "character");
		/* Remove reminder box if we have playbook or crew name */
		if (v.playbook || v.crew_type) setAttr("show_playbook_reminder", "0");
	});
	/* Setup and upgrades */
	getAttrs(["version"], v => {
		const upgradeSheet = version => {
				//const [major, minor] = version && version.split(".").map(x => parseInt(x));
				console.log(`Found version ${version}.`);
			},
			initialiseSheet = () => {
				const setting = ["ability", "friend", "crewability", "contact", "playbookitem", "upgrade", "framefeature"]
					.reduce((memo, sectionName) => {
						memo[`repeating_${sectionName}_${generateRowID()}_autogen`] = 1;
						return memo;
					}, {});
				mySetAttrs(setting);
				fillRepeatingSectionFromData("item", data.items);
				/* Set translated default values */
				getAttrs(Object.keys(data.translatedDefaults), v => {
					const setting = {};
					Object.keys(data.translatedDefaults).forEach(k => {
						if (v[k] !== data.translatedDefaults[k]) setting[k] = data.translatedDefaults[k];
					});
					mySetAttrs(setting);
				});
				console.log("Initialising new sheet.");
			};
		if (v.version) upgradeSheet(v.version);
		else initialiseSheet();
		// Set version number
		mySetAttrs({
			version: sheetVersion,
			character_sheet: `${sheetName} v${sheetVersion}`,
		});
	});
});
</script>
